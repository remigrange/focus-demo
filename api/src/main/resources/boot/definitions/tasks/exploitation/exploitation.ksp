package rodolphe.demo.dao.exploitation

create Task TK_UPDATE_MOVIES_TITLES {
    className : "io.vertigo.dynamox.task.TaskEngineProcBatch"
        request : "
        	UPDATE movie
   			SET title = #DTC_MOVIES.0.TITLE#, released= #DTC_MOVIES.0.RELEASED#, runtime= #DTC_MOVIES.0.RUNTIME#, 
   			description= #DTC_MOVIES.0.DESCRIPTION#, metadas_json=#DTC_MOVIES.0.METADAS_JSON#, imdbid= #DTC_MOVIES.0.IMDBID#,
   			year= #DTC_MOVIES.0.YEAR#
       		WHERE mov_id = #DTC_MOVIES.0.MOV_ID#
			"
	attribute DTC_MOVIES	 	{domain : DO_DT_MOVIE_DTC 		notNull:"true" 	inOut :"in"}
}

create Task TK_GET_ALL_TEMP_MOVIE_DATA{
	className : "io.vertigo.dynamox.task.TaskEngineSelect"
    request : " 
    			select * from temp_movie_data 
	"
    attribute DTC_TEMP_MOVIE 	{domain : DO_DT_TEMP_MOVIE_DATA_DTC 	notNull:"true" 			inOut :"out"}
}

create Task TK_GET_MOVIE_TO_CLEAN{
	className : "io.vertigo.dynamox.task.TaskEngineSelect"
    request : " 
    			select * 
    			from movie mov
    			where 
    				regexp_replace(lower(mov.title), '[^\w\s]', '', 'g')  like regexp_replace(lower(#TITLE#), '[^\w\s]', '', 'g')||'%%'
    				<% if (released != null) { %>
						and mov.released = #RELEASED#
					<% } %>	
				    <% if (year != null) { %>
						and mov.year = #YEAR#
					<% } %>	
	"
    attribute TITLE 		{domain : DO_ID 			notNull:"true" 			inOut :"in"}
    attribute RELEASED 		{domain : DO_DATE 			notNull:"false" 		inOut :"in"}
    attribute YEAR	 		{domain : DO_ENTIER 		notNull:"false" 		inOut :"in"}
    attribute DTC_MOVIE 	{domain : DO_DT_MOVIE_DTC 	notNull:"true" 			inOut :"out"}
}
